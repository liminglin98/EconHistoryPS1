---
title: "Economic History"
subtitle: "Assignment 1"
author: ""
date: "Oct. 23th, 2025"
output:
  pdf_document: default
  html_document: default
url_color: blue
---
# Check and Load necessary libraries
```{r}
pkg_loader <- function(pkg){
  if(!require(pkg, character.only = TRUE, quietly = TRUE)){
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}
pkg_loader("tidyverse")
pkg_loader("data.table")
pkg_loader("readr")
pkg_loader("dplyr")
pkg_loader("ggplot2")
pkg_loader("stringr")
pkg_loader("lubridate")
pkg_loader("readxl")
pkg_loader("here")
pkg_loader("fixest")
```
# Load data from the current folder
```{r}
stock_income <- read_excel(here("stock_income.xlsx"), sheet = 1)
car <- read_excel(here("StateNewCarRegistrations.xlsx"), sheet = 1)
```
# Clean the car data
```{r}
regex_pattern <- "^[-+]?[0-9]*\\.?[0-9]+$"
car_clean <- car %>%
  filter(grepl(regex_pattern, month)) %>%
  pivot_longer(
    cols = -c(month,year),
    names_to = "state",
    values_to = "registrations"
  ) 
```
# Merge the two datasets
```{r}
combined_data <- left_join(car_clean, stock_income, by = "state") %>%
  select(state, everything()) %>%
  mutate(month = factor(month, levels = 1:12, ordered = TRUE)) %>%
  arrange(state, year, month)
```
# Create the post-crash dummy variable
```{r}
combined_data <- combined_data %>%
  mutate(post_crash = ifelse(year > 1929 | (year == 1929 & month > 10), 1, 0))
```  
# 5. An ideal measure of $x_s$ would be the average changes in stock wealth per capita.
# Construct a variable that measures the exposure of a state to the stock market
```{r}
combined_data <- combined_data %>%
  mutate(stock_exposure = dividend_income / total_income)
```  
# The idea behind this measure is that dividends income represents the returns that households in a state receive from their stock holdings. Therefore, we may assume that states with higher dividend income percentage have more investment in the stock market.

# 7. The regression uses a generalized difference-in-differences approach. It estimates the effect of the crash by comparing how consumption ($y_{st}$) changed after the crash ($D_t=1$) across states ($s$) based on their pre-crash exposure level ($x_s$). The state fixed effects ($\mu_s$) account for constant differences across states, while the time fixed effects ($\gamma_t$) account for common trends affecting all states over time. The key coefficient, $\beta$, isolates the additional impact of the crash on states with higher exposure, assuming that otherwise, trends would have been parallel across states with different exposure levels (after controlling for the fixed effects).However, a major identification concern is the potential violation of this parallel trends assumption. The pre-crash exposure measure, $x_s$, might be correlated with unobserved, state-specific factors that were already causing differential consumption trends before 1929. For instance, states with higher $x_s$ might have been on different economic growth paths. If these pre-existing trends continued after the crash, the model could wrongly attribute the difference to the crash effect ($\beta$) instead of the underlying trend. Additionally, using 1928 data introduces potential measurement error if exposure significantly changed between 1928 and late 1929.

# 8. Estimate the regression
```{r}
combined_data <- combined_data %>%
  mutate(log_sale = log(registrations)) %>%
  mutate(year_month = make_date(year, as.numeric(month), 1))
model1 <- combined_data %>%
  filter(year>=1929 & year<=1930) %>%
  feols(log_sale ~ stock_exposure * post_crash | state + year_month)
summary(model1)
```